#!/usr/bin/env bash

set -eE
set -o pipefail

build() {
  local src_dir=$1
  local install_dir=$2
  local n_cores=$3

  tmp_dir=$(mktemp -d "${TMPDIR:-/tmp}/asdf-qt-XXXXXXXXXX")

  # cleanup on failures
  trap "rm -rf $tmp_dir" EXIT
  trap "rm -rf $install_dir" ERR

  cd $tmp_dir

  $src_dir/configure \
    -developer-build \
    -prefix $install_dir \
    -opensource \
    -confirm-license \
    -nomake examples \
    -nomake tests

  make -j$n_cores
  make install
}

main() {
  local install_type=$1
  local version=$2
  local download_path=$3
  local install_path=$4
  local n_cores=$5

  if [[ $install_type == "ref" ]]; then
    mv "${download_path}"/* "${install_path}"
  elif [[ $install_type == "ref" ]]; then
    install "${download_path}" "${install_path}" "${n_cores}"
  else
    echo "Unknown install type: $install_type"
    exit 1
  fi
}

main $ASDF_INSTALL_TYPE $ASDF_INSTALL_VERSION $ASDF_DOWNLOAD_PATH $ASDF_INSTALL_PATH $ASDF_CONCURRENCY
