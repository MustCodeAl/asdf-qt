#!/usr/bin/env bash

set -e
set -o pipefail

clone_repo() {
  local src_dir=$1
  local version=$2

  git clone git://code.qt.io/qt/qt5.git $src_dir
  cd $src_dir

  git checkout "v${version}"
  perl init-repository
}

build() {
  local src_dir=$1
  local build_dir=$2
  local install_dir=$3

  mkdir $build_dir
  cd $build_dir

  $src_dir/configure \
    -developer-build \
    -opensource \
    -confirm-license \
    -nomake examples \
    -nomake tests
}

install_qt() {
  local install_type=$1
  local version=$2
  local install_path=$3
  local n_cores=$4

  tmp_dir=$(mktemp -d "${TMPDIR:-/tmp}/asdf-qt-XXXXXXXXXX")
  trap "rm -rf $tmp_dir" EXIT

  src_dir="$tmp_dir/src"
  clone_repo $src_dir $version

  build_dir="$tmp_dir/build"
  build $src_dir $build_dir

  # install
  mv $build_dir/qtbase $install_path
}

install_qt $ASDF_INSTALL_TYPE $ASDF_INSTALL_VERSION $ASDF_INSTALL_PATH $ASDF_CONCURRENCY
